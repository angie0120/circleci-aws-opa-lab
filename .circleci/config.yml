version: 2.1

jobs:
  policy-validation:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install OPA and jq
          command: |
            sudo apt-get update
            sudo apt-get install -y jq curl
            curl -L -o opa https://openpolicyagent.org/downloads/v0.58.0/opa_linux_amd64_static
            chmod +x opa
            sudo mv opa /usr/local/bin/
      - run:
          name: Run OPA unit tests
          command: opa test policies/ tests/
      - run:
          name: Validate compliant resources
          command: |
            cat > compliant.json \<<'JSON'
            {
              "resource_type": "aws_s3_bucket",
              "server_side_encryption_configuration": {
                "rule": { "apply_server_side_encryption_by_default": { "sse_algorithm": "AES256" } }
              },
              "versioning": { "enabled": true }
            }
            JSON
            opa eval -d policies/ -i compliant.json "data.aws.s3.security.deny" --format pretty

  deploy-compliant-infra:
    docker:
      - image: cimg/base:stable
    environment:
      AWS_DEFAULT_REGION: us-east-1
    steps:
      - checkout
      - run:
          name: Install AWS CLI and Terraform
          command: |
            sudo apt-get update
            sudo apt-get install -y unzip jq curl
            curl -sS https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o awscliv2.zip
            unzip -o awscliv2.zip
            sudo ./aws/install
            wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
            unzip -o terraform_1.6.0_linux_amd64.zip
            sudo mv terraform /usr/local/bin/
      - run:
          name: Deploy compliant S3 bucket
          command: |
            export AWS_ROLE_ARN="arn:aws:iam::399966706844:role/CircleCILabRole"
            export AWS_WEB_IDENTITY_TOKEN_FILE="/tmp/web-identity-token"
            echo "$CIRCLE_OIDC_TOKEN" > "$AWS_WEB_IDENTITY_TOKEN_FILE"

            mkdir -p terraform
            cd terraform

            cat > main.tf \<<'TERRAFORM'
            provider "aws" {
              region = "us-east-1"
            }

            resource "random_string" "suffix" {
              length  = 8
              special = false
              upper   = false
            }

            resource "aws_s3_bucket" "compliant_bucket" {
              bucket = "circleci-lab-compliant-${random_string.suffix.result}"
            }

            resource "aws_s3_bucket_server_side_encryption_configuration" "compliant_encryption" {
              bucket = aws_s3_bucket.compliant_bucket.id
              rule {
                apply_server_side_encryption_by_default {
                  sse_algorithm = "AES256"
                }
              }
            }

            resource "aws_s3_bucket_public_access_block" "compliant_pab" {
              bucket                  = aws_s3_bucket.compliant_bucket.id
              block_public_acls       = true
              block_public_policy     = true
              ignore_public_acls      = true
              restrict_public_buckets = true
            }

            resource "aws_s3_bucket_versioning" "compliant_versioning" {
              bucket = aws_s3_bucket.compliant_bucket.id
              versioning_configuration {
                status = "Enabled"
              }
            }

            output "bucket_name" {
              value = aws_s3_bucket.compliant_bucket.bucket
            }
            TERRAFORM

            terraform init
            terraform apply -auto-approve
            terraform output

            # Clean up to avoid charges
            terraform destroy -auto-approve

workflows:
  security-pipeline:
    jobs:
      - policy-validation
      - deploy-compliant-infra:
          requires:
            - policy-validation
