version: 2.1

jobs:
  policy-validation:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install OPA and jq
          command: |
            set -e
            sudo apt-get update
            sudo apt-get install -y jq curl
            curl -L -o opa https://openpolicyagent.org/downloads/v0.58.0/opa_linux_amd64_static
            chmod +x opa && sudo mv opa /usr/local/bin/
      - run:
          name: Run OPA unit tests
          command: opa test policies/ tests/
      - run:
          name: Validate compliant resources
          command: |
            cat > compliant.json \<<'JSON'
            {
              "resource_type": "aws_s3_bucket",
              "server_side_encryption_configuration": {
                "rule": { "apply_server_side_encryption_by_default": { "sse_algorithm": "AES256" } }
              },
              "versioning": { "enabled": true }
            }
            JSON
            opa eval -d policies/ -i compliant.json "data.aws.s3.security.deny" --format pretty

  deploy-compliant-infra:
    docker:
      - image: cimg/base:stable
    environment:
      AWS_DEFAULT_REGION: us-east-1
    steps:
      - checkout
      - run:
          name: Install AWS CLI (apt) and Terraform
          command: |
            set -euxo pipefail
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends unzip jq curl awscli ca-certificates
            aws --version
            # Terraform via curl
            TF_VERSION=1.6.0
            curl -fsSL "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip" -o terraform.zip
            unzip -q -o terraform.zip
            sudo mv -f terraform /usr/local/bin/terraform
            terraform -version
      - run:
          name: OIDC assume role + Terraform apply & destroy (single step)
          command: |
            set -e
            # OIDC must be set IN THIS STEP
            export AWS_ROLE_ARN="${AWS_ROLE_ARN:-arn:aws:iam::399966706844:role/CircleCILabRole}"
            export AWS_WEB_IDENTITY_TOKEN_FILE="/tmp/web-identity-token"
            echo "$CIRCLE_OIDC_TOKEN" > "$AWS_WEB_IDENTITY_TOKEN_FILE"

            echo "STS identity (sanity check):"
            aws sts get-caller-identity

            mkdir -p terraform
            cd terraform

            cat > main.tf \<<'TERRAFORM'
            terraform {
              required_version = ">= 1.6.0"
              required_providers {
                aws    = { source = "hashicorp/aws",    version = ">= 5.0" }
                random = { source = "hashicorp/random", version = ">= 3.0" }
              }
            }

            provider "aws" { region = "us-east-1" }

            resource "random_string" "suffix" {
              length  = 8
              special = false
              upper   = false
            }

            resource "aws_s3_bucket" "compliant_bucket" {
              bucket = "circleci-lab-compliant-${random_string.suffix.result}"
            }

            resource "aws_s3_bucket_server_side_encryption_configuration" "compliant_encryption" {
              bucket = aws_s3_bucket.compliant_bucket.id
              rule {
                apply_server_side_encryption_by_default {
                  sse_algorithm = "AES256"
                }
              }
            }

            resource "aws_s3_bucket_public_access_block" "compliant_pab" {
              bucket                  = aws_s3_bucket.compliant_bucket.id
              block_public_acls       = true
              block_public_policy     = true
              ignore_public_acls      = true
              restrict_public_buckets = true
            }

            resource "aws_s3_bucket_versioning" "compliant_versioning" {
              bucket = aws_s3_bucket.compliant_bucket.id
              versioning_configuration { status = "Enabled" }
            }

            output "bucket_name" { value = aws_s3_bucket.compliant_bucket.bucket }
            TERRAFORM

            terraform init -input=false
            terraform plan -out=tfplan -input=false
            terraform apply -auto-approve tfplan

            echo "✅ Compliant infrastructure deployed:"
            terraform output

            # Always cleanup to avoid charges
            terraform destroy -auto-approve
            echo "✅ Cleaned up"

workflows:
  security-pipeline:
    jobs:
      - policy-validation
      - deploy-compliant-infra:
          requires:
            - policy-validation
