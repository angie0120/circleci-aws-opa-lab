version: 2.1

jobs:
  test:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Hello World
          command: echo "Hello from CircleCI!"

  policy-validation:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install OPA and jq
          command: |
            sudo apt-get update
            sudo apt-get install -y jq curl
            curl -L -o opa https://openpolicyagent.org/downloads/v0.58.0/opa_linux_amd64_static
            chmod +x opa
            sudo mv opa /usr/local/bin/
      - run:
          name: Run OPA unit tests
          command: |
            opa version
            opa test policies/ tests/
      - run:
          name: Evaluate sample resources
          command: |
            # Compliant sample
            cat > compliant-s3.json \<<'JSON'
            {
              "resource_type": "aws_s3_bucket",
              "server_side_encryption_configuration": {
                "rule": { "apply_server_side_encryption_by_default": { "sse_algorithm": "AES256" } }
              },
              "versioning": { "enabled": true }
            }
            JSON

            # Non-compliant sample
            cat > noncompliant-s3.json \<<'JSON'
            {
              "resource_type": "aws_s3_bucket",
              "acl": "public-read"
            }
            JSON

            echo "Compliant eval (expect no denies):"
            opa eval -d policies/ -i compliant-s3.json "data.aws.s3.security.deny" --format pretty

            echo "Non-compliant eval (expect denies):"
            opa eval -d policies/ -i noncompliant-s3.json "data.aws.s3.security.deny" --format pretty

  validate-terraform:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install OPA and jq
          command: |
            sudo apt-get update
            sudo apt-get install -y jq curl
            curl -L -o opa https://openpolicyagent.org/downloads/v0.58.0/opa_linux_amd64_static
            chmod +x opa
            sudo mv opa /usr/local/bin/
      - run:
          name: Validate (intentionally non-compliant) resources and fail on denies
          command: |
            # Simulate parsed Terraform resources (non-compliant on purpose)
            cat > terraform-resources.json \<<'JSON'
            [
              {
                "resource_type": "aws_s3_bucket",
                "resource_name": "policy_violation_bucket"
              },
              {
                "resource_type": "aws_s3_bucket_acl",
                "resource_name": "policy_violation_bucket_acl",
                "acl": "public-read"
              }
            ]
            JSON

            VIOLATIONS=0
            LEN=$(jq 'length' terraform-resources.json)
            for i in $(seq 0 $((LEN-1))); do
              jq -c ".[$i]" terraform-resources.json > /tmp/resource.json
              OUT=$(opa eval -d policies/ -i /tmp/resource.json 'data.aws.s3.security.deny[x]' --format json)
              if echo "$OUT" | jq -e '.result | length > 0' >/dev/null; then
                echo "❌ Violations for resource #$i:"
                echo "$OUT" | jq '.result'
                VIOLATIONS=$((VIOLATIONS+1))
              else
                echo "✅ No denies for resource #$i"
              fi
            done

            if [ "$VIOLATIONS" -gt 0 ]; then
              echo "❌ Failing build due to policy violations (expected on main)."
              exit 1
            fi
            echo "✅ No policy violations."

  test-aws-connection:
    docker:
      - image: cimg/base:stable
    environment:
      AWS_DEFAULT_REGION: us-east-1
    steps:
      - checkout
      - run:
          name: Install prerequisites
          command: |
            sudo apt-get update
            sudo apt-get install -y unzip jq curl
      - run:
          name: Install AWS CLI v2
          command: |
            curl -sS "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -o awscliv2.zip
            sudo ./aws/install
            aws --version
      - run:
          name: Configure OIDC and Test AWS STS (with fallback)
          command: |
            set -e
            export AWS_ROLE_ARN="${AWS_ROLE_ARN:-arn:aws:iam::399966706844:role/CircleCILabRole}"
            export AWS_WEB_IDENTITY_TOKEN_FILE="/tmp/web-identity-token"
            echo "$CIRCLE_OIDC_TOKEN" > "$AWS_WEB_IDENTITY_TOKEN_FILE"

            echo "Attempt 1: provider chain"
            if aws sts get-caller-identity >/dev/null 2>&1; then
              aws sts get-caller-identity
              exit 0
            fi

            echo "Attempt 2: explicit assume-role-with-web-identity"
            CREDS=$(aws sts assume-role-with-web-identity \
              --role-arn "$AWS_ROLE_ARN" \
              --role-session-name circleci-oidc \
              --web-identity-token "$CIRCLE_OIDC_TOKEN" \
              --duration-seconds 900)

            export AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r .Credentials.AccessKeyId)
            export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r .Credentials.SecretAccessKey)
            export AWS_SESSION_TOKEN=$(echo "$CREDS" | jq -r .Credentials.SessionToken)

            aws sts get-caller-identity
            echo "✅ AWS connection successful"

workflows:
  security-pipeline:
    jobs:
      - test
      - policy-validation:
          requires:
            - test
      # This gate should FAIL on main (intentional)
      - validate-terraform:
          requires:
            - policy-validation
      # Only runs if validate-terraform passed (e.g., on compliant branch later)
      - test-aws-connection:
          requires:
            - validate-terraform
